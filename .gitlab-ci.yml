image: geeksaccelerator/docker-library:golang1.12-docker

services:
  - docker:dind

variables:
  DOCKER_TLS_CERTDIR: ""

before_script:
  - 'go install ./build/cicd'

stages:
  - build:dev
  - migrate:dev
  - deploy:dev
  - build:stage
  - migrate:stage
  - deploy:stage
  - build:prod
  - migrate:prod
  - deploy:prod

cache:
  key: ${CI_COMMIT_REF_SLUG}

# Everything should get this, whether through subtemplates or explicitly
# embedded in a job.
.job_tmpl: &job_tmpl
  only:
    - master

.build_tmpl: &build_tmpl
  <<: *job_tmpl
  script:
    - 'cicd --env=${TARGET_ENV} build ${TARGET_TYPE} --name=${TARGET_REF}'

.deploy_tmpl: &deploy_tmpl
  <<: *job_tmpl
  script:
    - 'cicd --env=${TARGET_ENV} deploy ${TARGET_TYPE} --name=${TARGET_REF}'

.migrate_tmpl: &migrate_tmpl
  <<: *job_tmpl
  script:
    - 'cicd --env=${TARGET_ENV} schema migrate'

db:migrate:dev:
  <<: *migrate_tmpl
  stage: migrate:dev
  tags:
    - dev
  only:
    - master
    - dev
    - /^dev-.*$/
  variables:
    TARGET_ENV: 'dev'
    AWS_USE_ROLE: 'true'

aws-ecs-go-web-api:build:dev:
  <<: *build_tmpl
  stage: build:dev
  tags:
    - dev
  only:
    - master
    - dev
    - dev-web-api
  variables:
    TARGET_ENV: 'dev'
    TARGET_TYPE: 'service'
    TARGET_REF: 'aws-ecs-go-web-api'
    AWS_USE_ROLE: 'true'
aws-ecs-go-web-api:deploy:dev:
  <<: *deploy_tmpl
  stage: deploy:dev
  tags:
    - dev
  only:
    - master
    - dev
    - dev-web-api
  dependencies:
    - 'aws-ecs-go-web-api:build:dev'
    - 'db:migrate:dev'
  variables:
    TARGET_ENV: 'dev'
    TARGET_TYPE: 'service'
    TARGET_REF: 'aws-ecs-go-web-api'
    AWS_USE_ROLE: 'true'

aws-lambda-python-ddlogs:build:dev:
  <<: *build_tmpl
  stage: build:dev
  tags:
    - dev
  only:
    - master
    - dev
    - dev-web-api
  variables:
    TARGET_ENV: 'dev'
    TARGET_TYPE: 'function'
    TARGET_REF: 'aws-lambda-python-ddlogs'
    AWS_USE_ROLE: 'true'
aws-lambda-python-ddlogs:deploy:dev:
  <<: *deploy_tmpl
  stage: deploy:dev
  tags:
    - dev
  only:
    - master
    - dev
    - dev-web-api
  dependencies:
    - 'aws-lambda-python-ddlogs:build:dev'
    - 'db:migrate:dev'
  variables:
    TARGET_ENV: 'dev'
    TARGET_TYPE: 'function'
    TARGET_REF: 'aws-lambda-python-ddlogs'
    AWS_USE_ROLE: 'true'


